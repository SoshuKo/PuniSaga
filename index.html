<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ぷにさが</title>
  <style>
    :root{
      --sidebar-w: 260px;
      --bg0:#070912;
      --bg1:#0b1020;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --accent:#7bdcff;
      --accent2:#ff7bdc;
      --shadow: rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Arial;
      color:var(--text);
      background: radial-gradient(1200px 900px at 18% 8%, #2a3bd6 0%, var(--bg1) 38%, var(--bg0) 100%);
    }

    .app{ height:100%; display:flex; }

    /* Sidebar */
    aside{
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      max-width: var(--sidebar-w);
      padding: 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      border-right: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:auto;
    }
    .brand{ display:flex; align-items:center; gap:10px; padding: 8px 8px 12px; }
    .logo{ width:36px; height:36px; border-radius: 14px; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 12px 36px var(--shadow); }
    .brand h1{ margin:0; font-size: 14px; line-height:1.2; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .group{ margin-top: 10px; padding: 10px 8px; border-radius: 14px; background: rgba(0,0,0,.18); border: 1px solid rgba(255,255,255,.08); }
    .group-title{ margin:0 0 8px; font-size:12px; letter-spacing:.08em; color: rgba(255,255,255,.78); display:flex; align-items:center; gap:8px; }
    .pill{ display:inline-block; padding: 2px 8px; border-radius: 999px; font-size:11px; color: rgba(255,255,255,.72);
      background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10);
    }

    .char-btn{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      margin: 6px 0;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.10);
    }
    .char-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16); }
    .char-btn[aria-pressed="true"]{ background: rgba(123,220,255,.14); border-color: rgba(123,220,255,.45); box-shadow: 0 14px 40px rgba(123,220,255,.12); }

    .thumb{ width: 36px; height:36px; border-radius: 12px; overflow:hidden; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); display:grid; place-items:center; flex: 0 0 auto; }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .char-name{ font-size:14px; font-weight:800; letter-spacing:.02em; }

    .hint{ margin-top: 10px; padding: 10px 10px; border-radius: 14px; background: rgba(0,0,0,.18); border: 1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.78); font-size:12px; line-height:1.55;
    }

    /* Main */
    main{ position:relative; flex:1; overflow:hidden; }
    canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; touch-action:none; }

    #hud{ position:absolute; left:16px; right:16px; top:14px; display:flex; justify-content:space-between; align-items:center; gap:10px; z-index:3; pointer-events:none; }
    .hud-card{ display:inline-flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 14px;
      background: rgba(0,0,0,.22); border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.20);
    }
    .hud-title{ font-size:12px; color: rgba(255,255,255,.75); letter-spacing:.08em; }
    .hud-value{ font-size:18px; font-weight:900; }
    .tiny{ font-size:12px; color: rgba(255,255,255,.70); }

    .footer{ position:absolute; left:16px; bottom:12px; z-index:2; color: rgba(255,255,255,.60); font-size:12px; pointer-events:none; text-shadow: 0 2px 10px rgba(0,0,0,.35); }

    /* セリフ（小さく・邪魔にならない位置） */
    #toast{
      position:absolute;
      right: 16px;
      bottom: 12px;
      z-index: 5;
      pointer-events:none;
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      max-width: min(420px, 46vw);
    }
    .toast-item{
      width: fit-content;
      max-width: 100%;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 8px 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 55px rgba(0,0,0,.20);
      transform: translateY(6px);
      opacity: 0;
      animation: toastIn 160ms ease forwards, toastOut 260ms ease forwards;
      animation-delay: 0ms, var(--toast-life, 3600ms);
    }
    .toast-name{
      font-size: 11px;
      letter-spacing: .10em;
      color: rgba(255,255,255,.72);
      margin-bottom: 4px;
    }
    .toast-text{
      font-size: 12px;
      line-height: 1.45;
      color: rgba(255,255,255,.88);
      word-break: break-word;
    }
    @keyframes toastIn{
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes toastOut{
      to { transform: translateY(6px); opacity: 0; }
    }

    /* Mobile */
    #toggleSidebar{ display:none; }
    @media (max-width: 640px){
      #toggleSidebar{
        display:block;
        position:absolute;
        left:12px;
        top:12px;
        z-index: 12;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.24);
        color: var(--text);
        padding: 10px 12px;
        cursor:pointer;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 20px 70px rgba(0,0,0,.30);
      }
      #toggleSidebar:active{ transform: translateY(1px); }

      aside{
        position:absolute;
        left:12px;
        top:60px;
        bottom:12px;
        width: min(72vw, 280px);
        min-width: 0;
        max-width: min(72vw, 280px);
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,.12);
        box-shadow: 0 25px 80px rgba(0,0,0,.35);
        z-index: 11;
        transform: translateX(-110%);
        transition: transform 160ms ease;
      }
      aside.open{ transform: translateX(0%); }

      #hud{ left:12px; right:12px; top:64px; }
      .footer{ left:12px; }
      #toast{ right: 12px; bottom: 12px; max-width: min(420px, 64vw); }
    }
  </style>
</head>
<body>
  <div class="app">
    <button id="toggleSidebar" type="button">キャラ</button>

    <aside id="sidebar" aria-label="キャラクター選択">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ぷにさが</h1>
          <p>クリック/タップで浮かす</p>
        </div>
      </div>

      <div id="charList"></div>

      <div class="hint">
        ・上からぷにが落ちてきます<br />
        ・当てたぷにをクリック/タップすると「ふわっ」と浮きます<br />
        ・低確率でセリフが右下に小さく出ます<br />
        ・左の一覧でキャラクターを切り替えできます
      </div>
    </aside>

    <main>
      <div id="hud">
        <div class="hud-card">
          <div>
            <div class="hud-title">SCORE</div>
            <div class="hud-value" id="score">0</div>
          </div>
          <div class="tiny" id="combo">COMBO —</div>
          <div class="tiny" id="misses">MISS 0</div>
        </div>
        <div class="hud-card">
          <div>
            <div class="hud-title">SELECT</div>
            <div class="hud-value" id="selectedName">アルカ</div>
          </div>
        </div>
      </div>

      <div id="toast" aria-live="polite" aria-atomic="true"></div>

      <canvas id="game"></canvas>
      <div class="footer">画像ファイル（.png）はこの index.html と同じフォルダに置いてね</div>
    </main>
  </div>

<script>
(() => {
  // ===== キャラクター定義（画像は index.html と同じフォルダに置く） =====
  const CHAR_CATALOG = [
    { group: '五天', name: 'アルカ',     file: 'アルカ.png' },
    { group: '五天', name: 'キルロード', file: 'キルロード.png' },
    { group: '五天', name: 'キュビ',     file: 'キュビ.png' },
    { group: '五天', name: 'コト',       file: 'コト.png' },
    { group: '五天', name: 'アーシャ',   file: 'アーシャ.png' },
    { group: 'タネイ政権', name: 'タネイ', file: 'タネイ.png' },
    { group: 'タネイ政権', name: 'アカウ', file: 'アカウ.png' },
    { group: 'タネイ政権', name: 'カレイ', file: 'カレイ.png' },
    { group: 'ハーロピノン', name: 'サテラ', file: 'サテラ.png' },
    { group: 'ハーロピノン', name: 'シユウ', file: 'シユウ.png' },
    { group: 'ハーロピノン', name: 'モン', file: 'モン.png' },
    { group: 'ハーロピノン', name: 'シナン', file: 'シナン.png' },
    { group: 'パテイ政権', name: 'ガナリ', file: 'ガナリ.png' },
    { group: 'パテイ政権', name: 'パテイ', file: 'パテイ.png' },
  ];

  // ===== セリフ（クリック時：超低確率でランダム表示） =====
  // ※「超低確率」の具体値が未指定なので、まず 0.6%（約1/167）にしています。
  //    もっと低い/高いが良ければ数字だけ変えればOK。
  const QUOTE_CHANCE = 0.05;
  const QUOTE_LIFE_MS = 3600;
  const MAX_TOASTS = 2;

  const QUOTES = {
    'アルカ': [
      '「未知に触れて、この空虚が一瞬だけ黙る、その刹那のことだよ」',
      '「僕は君という人間をもっと、より深く知りたいと心の底から思ってるんだよ」',
      '「選べ。『傀儡』か『愛』を」',
      '「……神を指で突くとは、いい度胸だね。その指、切り落としても構わないかい？」',
    ],
    'コト': [
      '「ごきげんよう、愛しの旦那さま。コト・テイル・アイテールですわ」',
      '「わたくしにとって、『殺し』は『愛情』ですの」',
      '「あなたの愛はかわいすぎるわ」',
      '「あら、旦那さまでないなら興味はありませんの。……殺してさしあげましょうか？」',
    ],
    'キルロード': [
      '「傀儡でいいさ。俺らはどこまで行っても主の道具だしな」',
      '「あんまり人の内面を推しはかろうとするなよ。気持ち悪いぞ」',
      '「俺が切り拓いた血にまみれた道を悠々と歩いてくるだけでいい」',
      '「はぁ……。こんなことしてる暇があったら胃薬もってきてくれよ。……仕事、戻っていいか？」',
    ],
    'アーシャ': [
      '「これこそ『複式簿記』ですわ！」',
      '「『神は賽を振るうために人々に手を賜った』」',
      '「ふざけんじゃねーですわよ！！ぶっ殺しますわよ！！」',
      '「ちょっ！ 気安く触るなら料金が発生しますわよ！ 1クリックにつき5バウントですわ！」',
    ],
    'キュビ': [
      '「はい、死亡♡」',
      '「もしかしてアルカちゃんもざぁこ？」',
      '「じゃあ、えーりんちゃんが『我が主』って呼ばれるようになろ〜っと⭐︎」',
      '「ねえねえ、つまんな～い。この画面ごと壊しちゃっていい？ キャハハッ♡」',
    ],
    'タネイ': [
      '「笑ってほしい。生きていればそれでいい、そうだろう？」',
      '「それでも、みなから愛されたいと言ったら？」',
      '「わたしは第一教導職として、お前の過ちを、すべての国民の過ちを一身に背負う」',
      '「ふむ……。国民が望むなら、こうして浮いているのもまた『教導』のひとつなのだろうか？ ……いや、違う気がするな」',
    ],
    'アカウ': [
      '「私が殺したかった。自ら出向いた甲斐があった」',
      '「もう迷わない。わたしがラデン・タネイを守る」',
      '「『あなた』は優しすぎます。だから、わたしはあなたを愛しました」',
      '「気安く触るな！ 私が守るべきは第一教導職猊下ただお一人……！ 貴様にかまけている時間はないのだ！」',
    ],
    'カレイ': [
      '「あのさ、一緒にカラベイに来ないか。少し不自由だけど、治安がよくていい国だよ」',
      '「ぼくはきみと違って興味があって勉強しているんだ」',
      '「もうやめにしよう。ぼくに九地を止める義理はない」',
      '「わっ、揺らさないでくれるかな？ ……あぁ、よかった。大事なぬいぐるみが落ちるところだったよ」',
    ],
    
    'サテラ': [
      '「今は『模範囚』なの。残念だけど、戦闘シーンは見納め」', 
      '「この国の人々は本当に『不幸』ね」', 
      '「ごめんなさい。わたし、自分の国で仕事を見つけちゃって」', 
      '「暇ね……。あんたも皿洗い手伝う？ それとも、寮の掃除にする？」',
    ],

    'シユウ': [
      '「クロロアセトフェノン、致死性の猛毒だ」', 
      '「ダヒア、注射を打ってもいいか！注射！」', 
      '「前の監督、つまりきみたちの言う神さまに代わって、わたしがメガホンを握ろう」', 
      '「おい、私の体を揺らすな。貴重なサンプルを落としたらどう責任を取るつもりだ？」',
    ],

    'モン': [
      '「ヒトリ、イツモ、チャハン」', 
      '「タノマナイヤツ、ミセ、デロ！」', 
      '「なんたってあたしは地頭がいいからな、おまえら正真正銘のバカと違って」', 
      '「サワル、オカネ、トル。……チャハン、タベルカ？」',
    ],

    'シナン': [
      '「我が名はシナン・アルスノーヴァ！……超絶イカすこの街のヒーロー！」', 
      '「『幸せ』の定義はお天道さまが決める！それを『不幸』だなんて、暴慢もいいところだ！」', 
      '「アルスノーヴァ・パンチ！」', 
      '「おいおい、ヒーローを指先で転がすなんていい度胸だな？ 関節キメられたいのか？」',
    ],

    'ガナリ': [
      '「我々は約束を守ります。『商人』ですから」', 
      '「あなたは『わたしたち』が儲けを走らせるための『タイヤ』だ」', 
      '「計算と打算だったら、打算の方が儲かる。……そもそも計算するような人間は賭けをしませんからね」', 
      '「はぁ……。私を突いて何か利益が出ますか？ 無駄なコストは極力省きたいのですが」',
    ],

    'パテイ': [
      '「じゃあ、おれ、逃げるから」', 
      '「女なんだよな？エルテーナの女は胸はでかいのか？」 ', 
      '「楽器ケースに身を隠そう！」 ', 
      '「き、気安く触るな！ 私は第一教導職だぞ！ ……ひぃッ！ ガ、ガナリには言いつけないでくれよ！？」',
    ],
  };

  // ===== UI =====
  const sidebar = document.getElementById('sidebar');
  const toggleSidebarBtn = document.getElementById('toggleSidebar');
  const charListEl = document.getElementById('charList');
  const scoreEl = document.getElementById('score');
  const comboEl = document.getElementById('combo');
  const missesEl = document.getElementById('misses');
  const selectedNameEl = document.getElementById('selectedName');
  const toastEl = document.getElementById('toast');

  toggleSidebarBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
  });

  // ===== 画像プリロード =====
  const images = new Map();
  function loadImage(file){
    if(images.has(file)) return images.get(file);
    const img = new Image();
    img.src = encodeURI('./' + file);
    img.decoding = 'async';
    images.set(file, img);
    return img;
  }

  // サイドバー生成
  const groups = Array.from(new Set(CHAR_CATALOG.map(c => c.group)));
  let activeChar = CHAR_CATALOG[0];

  function buildSidebar(){
    charListEl.innerHTML = '';
    for(const g of groups){
      const wrap = document.createElement('div');
      wrap.className = 'group';

      const title = document.createElement('div');
      title.className = 'group-title';
      title.innerHTML = `<span class="pill">${g}</span><span>キャラクター</span>`;
      wrap.appendChild(title);

      for(const c of CHAR_CATALOG.filter(x => x.group === g)){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'char-btn';
        btn.setAttribute('aria-pressed', String(c.name === activeChar.name));

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        const img = loadImage(c.file);
        const imgEl = document.createElement('img');
        imgEl.alt = c.name;
        imgEl.src = img.src;
        thumb.appendChild(imgEl);

        const name = document.createElement('div');
        name.className = 'char-name';
        name.textContent = c.name;

        btn.appendChild(thumb);
        btn.appendChild(name);

        btn.addEventListener('click', () => {
          activeChar = c;
          selectedNameEl.textContent = c.name;
          for(const b of charListEl.querySelectorAll('.char-btn')) b.setAttribute('aria-pressed','false');
          btn.setAttribute('aria-pressed','true');
          sidebar.classList.remove('open');
        });

        wrap.appendChild(btn);
      }

      charListEl.appendChild(wrap);
    }
  }
  buildSidebar();

  // ===== セリフ表示（トースト） =====
  function showToast(name, text){
    const item = document.createElement('div');
    item.className = 'toast-item';
    item.style.setProperty('--toast-life', `${QUOTE_LIFE_MS}ms`);

    const n = document.createElement('div');
    n.className = 'toast-name';
    n.textContent = name;

    const t = document.createElement('div');
    t.className = 'toast-text';
    t.textContent = text;

    item.appendChild(n);
    item.appendChild(t);
    toastEl.appendChild(item);

    // 最大件数
    while(toastEl.children.length > MAX_TOASTS){
      toastEl.removeChild(toastEl.firstElementChild);
    }

    // 消えるタイミング（CSSアニメと同じ）
    window.setTimeout(() => item.remove(), QUOTE_LIFE_MS + 300);
  }

  function maybeShowQuote(charName){
    if(Math.random() > QUOTE_CHANCE) return;
    const list = QUOTES[charName];
    if(!list || list.length === 0) return;
    const line = list[Math.floor(Math.random() * list.length)];
    showToast(charName, line);
  }

  // ===== ゲーム描画（Canvas） =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: true });

  let W = 0, H = 0, DPR = 1;
  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = canvas.clientWidth;
    H = canvas.clientHeight;
    canvas.width = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  new ResizeObserver(resize).observe(canvas);
  window.addEventListener('resize', resize, { passive:true });
  resize();

  // ===== ぷに（物体） =====
  const blobs = [];
  const particles = [];

  // 放置デスポーン（触ってないぷにが増えすぎないようにする）
  const IDLE_DESPAWN_MS = 9000; // 9秒触られなかったら消える
  const MAX_BLOBS = 70;         // 念のため上限（超えたら放置が長い順に消す）

  const rng = (a,b) => a + Math.random() * (b-a);

  let score = 0;
  let combo = 0;
  let misses = 0;

  function setScore(delta){
    score += delta;
    scoreEl.textContent = String(score);
  }
  function setCombo(v){
    combo = v;
    comboEl.textContent = `COMBO ${combo || '—'}`;
  }
  function setMisses(v){
    misses = v;
    missesEl.textContent = `MISS ${misses}`;
  }

  function shouldIdleDespawn(blob, nowMs){
    const base = (blob.lastTouch ?? blob.born ?? 0);
    return base > 0 && (nowMs - base) > IDLE_DESPAWN_MS;
  }

  function enforceBlobCap(){
    while(blobs.length > MAX_BLOBS){
      let worst = 0;
      for(let i=1;i<blobs.length;i++){
        if((blobs[i].lastTouch ?? 0) < (blobs[worst].lastTouch ?? 0)) worst = i;
      }
      blobs.splice(worst, 1);
    }
  }

  function spawnBlob(nowMs = performance.now()){
    if(W < 40 || H < 40) return;

    const baseR = Math.min(W, H) * rng(0.045, 0.070);
    const r = Math.max(22, Math.min(64, baseR));
    const x = rng(r, W - r);
    const y = -r - rng(0, 120);
    const vx = rng(-40, 40);
    const vy = rng(60, 140);
    const w = rng(-0.8, 0.8);

    let file = activeChar.file;
    if (activeChar.name === 'パテイ' && Math.random() < 0.05) {
    file = '実写パテイ.png';
    }
    const img = loadImage(file);

    blobs.push({
      x, y, vx, vy, r,
      rot: rng(-0.4, 0.4),
      w,
      born: nowMs,
      img,
      name: activeChar.name,
      floatFlash: 0,
      lastTouch: nowMs,
    });

    enforceBlobCap();
  }

  // ===== パーティクル =====
  function burst(x,y, n=14){
    for(let i=0;i<n;i++){
      particles.push({
        x, y,
        vx: rng(-160,160),
        vy: rng(-220,60),
        life: rng(0.35, 0.75),
        t: 0,
        s: rng(1.2, 2.2),
      });
    }
  }

  // ===== 入力（クリック/タップ） =====
  function pointerToCanvas(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left);
    const y = (e.clientY - rect.top);
    return { x, y };
  }

  function tryHit(px, py){
    for(let i = blobs.length - 1; i >= 0; i--){
      const b = blobs[i];
      const dx = px - b.x;
      const dy = py - b.y;
      if(dx*dx + dy*dy <= b.r*b.r){
        const nowMs = performance.now();
        b.lastTouch = nowMs;

        // 浮かす（上方向インパルス）
        b.vy = -Math.min(900, 420 + Math.abs(b.vy) * 0.7);
        b.vx += rng(-120, 120);
        b.rot += rng(-0.35, 0.35);
        b.floatFlash = 0.35;

        // スコア
        setCombo(Math.min(999, combo + 1));
        const add = Math.floor(10 + (b.r - 22) * 0.7 + combo * 2);
        setScore(add);
        burst(b.x, b.y, 12);

        // 超低確率セリフ
        maybeShowQuote(b.name);

        return true;
      }
    }
    setCombo(0);
    return false;
  }

  canvas.addEventListener('pointerdown', (e) => {
    canvas.setPointerCapture?.(e.pointerId);
    const { x, y } = pointerToCanvas(e);
    tryHit(x, y);
  }, { passive:true });

  // ===== 背景（星っぽい点） =====
  const stars = Array.from({length: 90}, () => ({
    x: Math.random(),
    y: Math.random(),
    r: rng(0.6, 1.8),
    a: rng(0.12, 0.40),
    s: rng(6, 24),
  }));

  function drawBackground(t){
    const g = ctx.createRadialGradient(W*0.18, H*0.10, 10, W*0.18, H*0.10, Math.max(W,H));
    g.addColorStop(0, 'rgba(123,220,255,0.10)');
    g.addColorStop(0.45, 'rgba(255,123,220,0.04)');
    g.addColorStop(1, 'rgba(0,0,0,0.25)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    for(const s of stars){
      const tw = 0.5 + 0.5*Math.sin((t/1000) * (1.1 + s.s/18) + (s.x+s.y)*9);
      ctx.globalAlpha = s.a * (0.7 + 0.6*tw);
      ctx.beginPath();
      ctx.arc(s.x*W, s.y*H, s.r, 0, Math.PI*2);
      ctx.fillStyle = 'white';
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  // ===== ループ =====
  let last = performance.now();
  let spawnAcc = 0;

  function step(now){
    const dt = Math.min(0.033, (now - last) / 1000);
    last = now;

    // 難易度（時間で少しだけ増える）
    const elapsed = now / 1000;
    const spawnEvery = Math.max(0.28, 0.85 - elapsed * 0.010);
    spawnAcc += dt;
    while(spawnAcc >= spawnEvery){
      spawnAcc -= spawnEvery;
      spawnBlob(now);
      if(Math.random() < 0.18) spawnBlob(now);
    }

    // 物理
    const gravity = 1400;
    const drag = 0.995;
    const bounce = 0.35;

    for(let i=blobs.length-1;i>=0;i--){
      const b = blobs[i];

      // 放置デスポーン（ミス扱いにはしない）
      if(shouldIdleDespawn(b, now)){
        burst(b.x, b.y, 8);
        blobs.splice(i, 1);
        continue;
      }

      b.vy += gravity * dt;
      b.vx *= Math.pow(drag, dt*60);
      b.vy *= Math.pow(drag, dt*60);
      b.x += b.vx * dt;
      b.y += b.vy * dt;
      b.rot += b.w * dt;

      // 壁
      if(b.x - b.r < 0){ b.x = b.r; b.vx = Math.abs(b.vx) * 0.55; }
      if(b.x + b.r > W){ b.x = W - b.r; b.vx = -Math.abs(b.vx) * 0.55; }

      // 下に落ちたらミス扱いで消す
      if(b.y - b.r > H + 120){
        blobs.splice(i, 1);
        setMisses(misses + 1);
        setCombo(0);
        continue;
      }

      // ふわっと演出の減衰
      b.floatFlash = Math.max(0, b.floatFlash - dt);

      // 画面下で軽く反発（“ぷにっ”感）
      const floorY = H - 6;
      if(b.y + b.r > floorY){
        b.y = floorY - b.r;
        if(b.vy > 0) b.vy = -b.vy * bounce;
      }
    }

    // パーティクル
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.t += dt;
      p.vy += 900 * dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      if(p.t >= p.life) particles.splice(i, 1);
    }

    // 描画
    ctx.clearRect(0,0,W,H);
    drawBackground(now);

    // 影
    for(const b of blobs){
      const sh = Math.max(0.08, 0.22 - Math.max(0, (b.y/H)) * 0.10);
      ctx.globalAlpha = sh;
      ctx.beginPath();
      ctx.ellipse(b.x, Math.min(H-4, b.y + b.r*0.92), b.r*0.85, b.r*0.30, 0, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // ぷに本体
    for(const b of blobs){
      const squash = Math.max(-0.28, Math.min(0.28, (b.vy/1400) * 0.22));
      const wobble = 0.05 * Math.sin((now - (b.born ?? now)) / 120 + b.r);
      const sx = 1 - squash + wobble;
      const sy = 1 + squash - wobble;

      ctx.save();
      ctx.translate(b.x, b.y);
      ctx.rotate((b.rot ?? 0) * 0.25);
      ctx.scale(sx, sy);

      if(b.floatFlash > 0){
        ctx.globalAlpha = Math.min(0.45, b.floatFlash);
        ctx.beginPath();
        ctx.arc(0, 0, b.r*1.20, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(123,220,255,0.35)';
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      if(b.img && b.img.complete && b.img.naturalWidth > 0){
        ctx.drawImage(b.img, -b.r, -b.r, b.r*2, b.r*2);
      }else{
        ctx.beginPath();
        ctx.arc(0,0,b.r,0,Math.PI*2);
        ctx.fillStyle = 'rgba(255,255,255,0.18)';
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(255,255,255,0.28)';
        ctx.stroke();
        ctx.fillStyle = 'rgba(255,255,255,0.75)';
        ctx.font = 'bold 14px ui-sans-serif, system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(b.name, 0, 0);
      }

      ctx.restore();
    }

    // パーティクル描画
    for(const p of particles){
      const a = 1 - (p.t / p.life);
      ctx.globalAlpha = a;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.s, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    requestAnimationFrame(step);
  }

  // ===== ミニテスト（ブラウザConsole用） =====
  function runTests(){
    console.assert(typeof QUOTE_CHANCE === 'number' && QUOTE_CHANCE >= 0 && QUOTE_CHANCE <= 1, 'TEST: QUOTE_CHANCE in [0,1]');
    console.assert(Array.isArray(QUOTES['アルカ']) && QUOTES['アルカ'].length >= 1, 'TEST: quotes exist');
    // toast DOM
    showToast('TEST', 'セリフ表示テスト');
    console.assert(toastEl.children.length >= 1, 'TEST: toast appended');
  }
  runTests();

  requestAnimationFrame(step);
})();
</script>
</body>
</html>
